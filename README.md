# my-blog
next.js 14버전을 이용하여 개인 블로그를 만들어 보도록 한다.

1. 컨셉 블로그 : https://chirpy.cotes.page/ 
2. 프론트엔드로만 구성
3. 사용된 라이브러리를 기록
4. 트러블슈팅을 기록
5. 전반적인 경험을 기록
  
# 배포 url
https://nam-yeun-hwa.github.io/ </br></br>
2024.2.14 v1.0.0


# 기술 스택
- next.js 14.0.4
- typescript
- redux-toolkit 


# 폴더구조

<pre>
├── public
└── src
    └── app
         ├── _components --- 공통컴포넌트 
         └── (layoutCase) --- 레이아웃 그룹
               └── _components --- 공통컴포넌트 
                      ├── contexts --- 컨텐스트 API
                      ├── store --- redux-toolkit
               ├── @modal --- 모달
               ├── algorithm --- 페이지 카테고리
               ├── archives --- 페이지 카테고리
               ├── algorithm --- 페이지 카테고리
               ├── categories --- 페이지 카테고리
               ├── posts ---  페이지 카테고리 일반적 공통 구조 > [다이나믹라우팅 slug]에 따라 내부로 page.tsx가 더 들어 있는 정도로 차이가 있다.
               │    ├── [postid] 
               │    │      ├── page.module.css 
               │    │      ├── page.tsx 
               │    └── page.tsx 
               ├── tags --- 페이지
               └── update --- 페이지
</pre>
# Troubleshooting

## 이슈
```shell
src/app/page.tsx You cannot have two parallel pages that resolve to the same path. Please check /page and /(layoutCase)/page. Refer to the route group docs for more information: https://nextjs.org/docs/app/building-your-application/routing/route-groups   
```
라우터 그룹으로 폴더를 생성하면(layoutCase) app 폴더에 page가 동시에 있을 경우 에러가 나오는 것 같다.
app의 page를 삭제하고 라우터 그룹의 page를 유지 하였다.

## 이슈
yarn dev 명령 후 프로젝트가 화면에 3초 이상 나타나지 않았다.
그리고 터미널에 아래와 같은 문구가 수없이 나타났다.

```shell
Retrying 1/3...
The user aborted a request.

Retrying 1/3...
The user aborted a request.

Retrying 1/3...
The user aborted a request.

Retrying 1/3...
The user aborted a request.
```
검색결과 해당 이슈에 관한 내용을 찾을 수 있었다. </br>
https://github.com/vercel/next.js/discussions/55734

아래와 같이 최상위 layout에서 구글 폰트를 className={imb_plex_sans_kR.variable} 으로 사용한것이 문제 같았고

 📄 layout.tsx
```shell
import type { Metadata } from 'next';
import { Inter, IBM_Plex_Sans_KR } from 'next/font/google';
import './globals.css';
import './style-reset.css';

const inter = Inter({ subsets: ['latin'] });

const imb_plex_sans_kR = IBM_Plex_Sans_KR({
  weight: ['400', '500', '600', '700'],
  variable: '--font-IBM_Plex_Sans_KR',
  subsets: ['latin'],
  display: 'swap',
});

export const metadata: Metadata = {
  title: 'Create Next App',
  description: 'Generated by create next app',
};

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <html lang="en" className={imb_plex_sans_kR.variable}>
      <head>
        <link
          rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
        />
      </head>
      <body className={inter.className}>{children}</body>
    </html>
  );
}

```

구글 폰트에서 사용하고 있는 폰트를 다운로드 하여 웹폰트 woff로 변환후에 
global.css에서 @font-face를 사용하였더니 해결 되었다.


 📄 global.css
 ```shell
  @font-face {
    font-family: 'IBM Plex Sans KR';
    src: url('/fonts/IBMPlexSansKR-Medium.woff') format('woff');
  }
```

```shell
body {
  font-family: 'IBM Plex Sans KR', sans-serif;
}

```
</br>
</br>
</br>

# next.14 정적 배포하기

📑 next.config.js 
next.config.js파일에 `output: 'export'` 을 추가 해준다.
next13이후에 아래 키워드를 추가하도록 변경 되었다.

```
  const nextConfig = {
    output: 'export',
  };
  
  module.exports = nextConfig;
```
https://nextjs.org/docs/app/building-your-application/deploying/static-exports


## 정적 배포 이슈

## Error : Page[categoryname]/[postid] is missing "generateStaticParams()" so it cannot be used with "output: export" config.
정적으로 페이지를 빌드 할 경우 슬러그를 받는 page.tsx에 generateStaticParams()를 넣어줘야 하는 이슈 였다.

📑 페이지 카테고리 경로 (category)
해당 페이지는 두개의 슬러그를 다이나믹 param으로 받고 있었고 
- [categoryname] page.tsx 에서는 categoryname의 parms을 사용하고
- [postid] page.tsx 에서는 postid parms을 사용하고 있었다.

<pre>
category  
 │    ├── [categoryname] 
 │    │      └── [postid]  
 │    │            └── page.tsx 
 └──  └── page.tsx 
</pre>

</br>
</br>
처음에는 다른 페이지와 동일 하게 아래와 같이 generateStaticParams() 구성 하였다.


📑 [categoryname] > page.tsx
페이지의 categoryname 값을 슬러그로 받아 페이지를 표시 하는 페이지이다.
```
type Props = {
  params: { categoryname: string; };
};

export function generateStaticParams() {
  const categoryFolder = ['React', 'Javascript'];
  return categoryFolder.map((value) => ({ categoryname: value }));
}
```

📑 [categoryname] > [postid] > page.tsx
페이지의 id 값을 받아 페이지를 표시 할수 잇도록 id값을 슬러그로 받는 페이지이다.
```
type Props = {
  params: { postid: string };
};

export function generateStaticParams() {
  return totalPostlist.map((value) => ({ postid: value.id.toString() }));
}
```

그러나 똑같이 버그가 발생하였다. 고민을 여러차례 해본 후 generateStaticParams에 관련한 페이지를 자세히 보니 
`app/products/[category]/[product]/page.tsx` 의 경로와 같이 슬러그안에 슬러그 폴더가 있는 경우에는 (다른 슬러그에 포함된) page.tsx의 경우에는 상위 슬러그 값들을 generateStaticParams()에 같이 넣어주도록 되어 있는것 같았다.

 🔗 해당 내용 관련 next.js 이미지
<img width="673" alt="스크린샷 2024-02-12 오후 10 18 05" src="https://github.com/nam-yeun-hwa/list-filter-with-nextjs14/assets/138950568/baaca2d5-bb4d-4718-9e7a-caebe7ce4367">
https://nextjs.org/docs/app/api-reference/functions/generate-static-params

</br>
</br>

## 해결
📑 [postid] page.tsx

```
type Props = {
  params: { categoryname: string; postid: string };
};

export function generateStaticParams() {
  const categoryFolder = ['React', 'Javascript'];
  return categoryFolder
    .map((parent) => {
      return totalPostlist.map((value) => {
        return { categoryname: parent, postid: value.id.toString() };
      });
    })
    .flat();
}

```
postid의 값을 받는 page.tsx에서는 상위 슬러그 값인 categoryname의 값을 사용하지 않지만 위와 같이 generateStaticParams()의 값을 수정 한 후 yarn build로 빌드를 성공 할수 있었다.

## 이슈 
## 로컬에서는 잘보이던 이미지가 배포 후 보이지 않는 문제 

<img width="200" height="auto" alt="이미지 링크가 깨진 이미지" src="https://nyhya.cafe24.com/git_img/issu01/no-profileimg.png">

📑  **문제의 코드**

프로젝트의 pulbic 폴더 안에 image 폴더에 이미지 파일이 들어 있었고 아래와 같이 코딩 하였었었으나 배포 후 이미지가 깨지는 문제가 발생 했다.

```
<Image
  className={style.img}
  src={'/image/profile1.jpg'}
  alt="프로필 사진"
  width={112}
  height={112}
/>
```

## 해결 

📑 **수정한 코드**

아래와 같이 next/image에 loader를 추가해 주었다. </br>
loader 옵션은 아래와 같이 직접 코드상에서 지정할 수 있고 next.config.js의 images 섹션에서도 지정할 수 있다.
```
import Image, { ImageLoaderProps } from 'next/image';
import style from './imageLoader.module.css';

export default function ImageLoader() {
  const myLoader = ({ src, width, quality }: ImageLoaderProps) => {
    return `${
      process.env.NEXT_PUBLIC_APP_API_BASE_URL
    }/image/${src}?w=${width}&q=${quality || 75}`;
  };
  return (
    <Image
      loader={myLoader}
      className={style.img}
      src={'profile1.jpg'}
      alt="프로필 사진"
      width={112}
      height={112}
    />
  );
}

```

📑 **next.config.js 파일에 Image 컴포넌트에 대한 옵션을 지정 하기**
next.config.js 파일에서 images 설정을 사용하여 loader와 loaderFile 속성을 설정해 준다.

```
const nextConfig = {
  images: {
    loader: 'custom',
    loaderFile: './my/image/loader.js',
    path: 'https://s3.amazonaws.com/image',
    formats:['image/avif', 'image/webp']
  },
  Unoptimized: false,
};

module.exports = nextConfig;

```
- **loader** : 로더를 이용하면 컴포넌트에서는 상대 경로로 이미지 위치를 지정하지만, 빌드(build) 시에 절대 경로로 Next.js가 자동으로 변환해 준다.
- **loaderFile** : loaderFile 속성은 커스텀 이미지 로더가 정의된 파일의 경로를 지정해준다. 아래 my/image/loader.js 파일을 기본으로 한다.
- **domains** : 여기서 지정된 호스트네임만 허용되며 그외의 외부 링크에 경우 에러를 발생시켜 next.config.js에 등록 하도록 했다.
- **formats** : formats 속성은 이미지를 어떤 형식으로 변환할지를 설정할 수 있습니다. 주로 웹P(WebP) 형식이나 AVIF 형식 등을 지정하여 이미지를 더 작은 용량으로 제공하여 성능을 향상시킬 수 있습니다.
- **Unoptimized** : Unoptimized 속성은 Next.js에서 이미지 최적화를 비활성화하는 속성이다. 이를 사용하면 Next.js의 내장 이미지 최적화 기능을 비활성화하고, 원본 이미지를 그대로 사용할 수 있다. </br>
일반적으로 Next.js에서 제공하는 <Image/> 컴포넌트는 이미지 최적화를 자동으로 처리하여 페이지 성능을 향상시키고, 사용자 경험을 개선한다. </br>
하지만 때로는 원본 이미지를 사용하거나 외부 이미지 최적화 서비스를 사용하고 싶을 수 있고 그럴 때 Unoptimized 속성을 사용하면 된다.</br>

📑 **my/image/loader.js**
```
'use client'

export default function myImageLoader({ src, width, quality }) {
  return `https://example.com/${src}?w=${width}&q=${quality || 75}`
}
```
https://nextjs.org/docs/pages/api-reference/components/image
